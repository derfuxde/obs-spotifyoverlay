<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify OBS Overlay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            /*overflow: hidden;*/
        }

        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* Einstellungsseite */
        .settings-page {
            padding: 30px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: none;
        }

        .settings-page.active {
            display: block;
        }

        .settings-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .settings-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #1db954, #1ed760);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .settings-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        

        .settings-card h3 {
            color: #1ed760;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .setting-item {
            margin-bottom: 20px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .setting-item input, .setting-item select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
        }

        .setting-item input:focus, .setting-item select:focus {
            outline: none;
            border-color: #1ed760;
            box-shadow: 0 0 0 2px rgba(30, 215, 96, 0.3);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .spotify-connection {
            margin-top: 15px;
        }

        .connection-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .status-text {
            font-size: 14px;
            color: #b3b3b3;
        }

        .status-text.connected {
            color: #1ed760;
        }

        .status-text.error {
            color: #ff6b6b;
        }

        .btn {
            background: linear-gradient(45deg, #1db954, #1ed760);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(29, 185, 84, 0.4);
        }

        .toggle-view {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }


        /* Overlay Player */
        .overlay-page {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
            position: relative;
        }


        .overlay-page.active {
            display: flex;
        }

        .lyrics-box {
            position: relative;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            background: linear-gradient(90deg, #1db954, #19a54a);
            margin-top: 30px; /* oder 1em / auto */
            font-size: 1rem;
            text-align: center;
            max-width: 700px;
            padding: 10px;
            line-height: 1.4;
            overflow: hidden;
            min-width: 500px;
        }

        .lyrics-line {
            margin: 4px 0;
            white-space: pre-wrap;
        }

        .current {
            color: #fff;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .gray {
            color: #424242;
        }

        .lyrics-icon {
            height: 24px;
            vertical-align: middle;
        }

        .spotify-player {
            width: 500px;
            height: 200px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            display: flex;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(29, 185, 84, 0.3);
            position: relative;
            overflow: hidden;
        }

        .spotify-player::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #1db954, #1ed760);
        }

        

        .album-art {
            width: 160px;
            height: 160px;
            border-radius: 15px;
            background: linear-gradient(45deg, #1db954, #1ed760);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            flex-shrink: 0;
            margin-right: 20px;
            position: relative;
            overflow: hidden;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
        }

        .song-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }

        .song-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #fff;
            white-space: normal;        /* Umbruch erlauben */
            word-break: break-word;     /* bei langen W√∂rtern umbrechen */
        }


        .song-artist {
            font-size: 1.0rem;
            color: #b3b3b3;
            margin-bottom: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .progress-container {
            margin-top: auto;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1db954, #1ed760);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #b3b3b3;
        }

        .demo-song {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .spotify-player {
                width: 90vw;
                height: auto;
                flex-direction: column;
                padding: 15px;
            }
            
            .album-art {
                width: 120px;
                height: 120px;
                margin-right: 0;
                margin-bottom: 15px;
                align-self: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="toggle-view" onclick="toggleView()">
            <span id="toggle-text">Zu Overlay wechseln</span>
        </button>

        <!-- Einstellungsseite -->
        <div class="settings-page active" id="settings-page">
            <div class="settings-header">
                <h1>üéµ Spotify OBS Overlay</h1>
                <p>Konfiguriere dein Spotify Overlay f√ºr OBS</p>
            </div>
            
            <div class="settings-grid">
                <div class="settings-card">
                    <h3>üìç Position & Gr√∂√üe</h3>
                    <div class="setting-item">
                        <label>X-Position (px):</label>
                        <input type="number" id="posX" value="50" min="0">
                    </div>
                    <div class="setting-item">
                        <label>Y-Position (px):</label>
                        <input type="number" id="posY" value="50" min="0">
                    </div>
                    <div class="setting-item">
                        <label>Overlay-Breite (px):</label>
                        <input type="number" id="width" value="500" min="200" max="800">
                    </div>
                    <div class="setting-item">
                        <label>Overlay-H√∂he (px):</label>
                        <input type="number" id="height" value="200" min="100" max="400">
                    </div>
                </div>

                <div class="settings-card">
                    <h3>üé∂ Anzeigeelemente</h3>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showSongName" checked>
                        <label for="showSongName">Song-Titel anzeigen</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showArtist" checked>
                        <label for="showArtist">K√ºnstler anzeigen</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showTimeline" checked>
                        <label for="showTimeline">Timeline anzeigen</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showAlbumArt" checked>
                        <label for="showAlbumArt">Album-Cover anzeigen</label>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>üé® Design</h3>
                    <div class="setting-item">
                        <label>Hintergrund-Transparenz:</label>
                        <input type="range" id="bgOpacity" min="0" max="100" value="90">
                        <span id="opacityValue">90%</span>
                    </div>
                    <div class="setting-item">
                        <label>Ecken-Rundung (px):</label>
                        <input type="number" id="borderRadius" value="20" min="0" max="50">
                    </div>
                    <div class="setting-item">
                        <label>Schriftgr√∂√üe Titel:</label>
                        <select id="titleSize">
                            <option value="1.0rem">Klein</option>
                            <option value="1.2rem">Mittel</option>
                            <option value="1.5rem" selected>Gro√ü</option>
                            <option value="1.8rem">Sehr gro√ü</option>
                        </select>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>üéµ Spotify Verbindung</h3>
                    <div class="setting-item">
                        <label>Client ID:</label>
                        <input type="text" id="clientId" placeholder="Deine Spotify Client ID">
                    </div>
                    <div class="setting-item">
                        <label>Redirect URI:</label>
                        <input type="text" id="redirectUri" value="http://localhost:8080/callback" placeholder="http://localhost:8080/callback">
                    </div>
                    <div class="spotify-connection">
                        <button class="btn" id="connectSpotify" onclick="requestSpotifyAuthLink()">üéµ Mit Spotify verbinden</button>
                        <div class="connection-status" id="connectionStatus">
                            <span class="status-text">Nicht verbunden</span>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>‚öôÔ∏è Erweiterte Einstellungen</h3>
                    <div class="setting-item">
                        <label>Update-Intervall (ms):</label>
                        <input type="number" id="updateInterval" value="500" min="500" max="5000">
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="autoHide">
                        <label for="autoHide">Automatisch ausblenden wenn pausiert</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showAnimation" checked>
                        <label for="showAnimation">Animationen aktivieren</label>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="applySettings()">Einstellungen anwenden</button>
        </div>

        <!-- Overlay Seite -->
        <div class="overlay-page" id="overlay-page">
            <div class="spotify-player demo-song" id="spotify-player">
                <div class="album-art" id="album-art">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSJncmFkaWVudCIvPgo8ZGVmcz4KPGF0dGVybmF0ZSBpZD0iZ3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgo8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjMWRiOTU0Ii8+CjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzFlZDc2MCIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjE1IiBmaWxsPSJ3aGl0ZSIgb3BhY2l0eT0iMC44Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjgiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=" alt="Album Cover" id="album-image">
                </div>
                <div class="song-info">
                    <div class="song-title" id="song-title">Bohemian Rhapsody</div>
                    <div class="song-artist" id="song-artist">Queen</div>
                    <div class="progress-container" id="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="time-display">
                            <span id="current-time">2:34</span>
                            <span id="total-time">5:55</span>
                        </div>
                    </div>
                </div>
                
            </div>
            <div id="lyrics-box" class="lyrics-box demo-song">
                <div id="prev-line" class="lyrics-line gray"></div>
                <div id="current-line" class="lyrics-line current"></div>
                <div id="next-line" class="lyrics-line gray"></div>
            </div>
        </div>
    </div>

    <script>
        let currentView = 'settings';
        let demoProgress = 0;
        let demoInterval;
        let spotifyApi = null;
        let accessToken = null;
        let refreshToken = null;
        let updateTimer = null;
        let isPlaying = false;
        let currentTrack = null;

        // Spotify API Configuration
        const SPOTIFY_CONFIG = {
            clientId: '',
            redirectUri: 'http://localhost:8080/callback',
            scopes: [
                'user-read-currently-playing',
                'user-read-playback-state',
                'streaming',
                'user-read-email',
                'user-read-private'
            ]
        };

        // Spotify API Class
        class SpotifyAPI {
            constructor() {
                this.baseUrl = 'https://api.spotify.com/v1';
            }

            async getCurrentlyPlaying() {
                if (!accessToken) return null;

                try {
                    const response = await fetch(`${this.baseUrl}/me/player/currently-playing`, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    if (response.status === 204) {
                        return null; // Nothing playing
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error fetching currently playing track:', error);
                    return null;
                }
            }

            async getPlayerState() {
                if (!accessToken) return null;

                try {
                    const response = await fetch(`${this.baseUrl}/me/player`, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    if (response.status === 204) {
                        return null; // No active device
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error fetching player state:', error);
                    return null;
                }
            }
        }

        // Initialize Spotify API
        spotifyApi = new SpotifyAPI();

        async function requestSpotifyAuthLink() {
            const res = await fetch('http://localhost:8080/auth/spotify');
            const data = await res.json();

            const clientId = document.getElementById('clientId').value;
            const redirectUri = document.getElementById('redirectUri').value;

            if (!clientId) {
                alert('Bitte gib deine Spotify Client ID ein!');
                return;
            }

            SPOTIFY_CONFIG.clientId = clientId;
            SPOTIFY_CONFIG.redirectUri = redirectUri;

            // Save config
            storeConfig('clientId', clientId);
            storeConfig('redirectUri', redirectUri);

            storeConfig('auth_state', data.state);

            if (data.authUrl && data.sessionId) {
                const popup = window.open(data.authUrl, '_blank');
                console.log("jaja")
                if (!popup) {
                    updateConnectionStatus('Fenster konnte nicht ge√∂ffnet werden.', 'error');
                }

                window.addEventListener('message', handleAuthMessage);
            } else {
                console.error("Fehler beim Holen des Auth-Links:", data);
            }
        }


        // Spotify Connection
        function connectSpotify() {
            const clientId = document.getElementById('clientId').value;
            const redirectUri = document.getElementById('redirectUri').value;

            if (!clientId) {
                alert('Bitte gib deine Spotify Client ID ein!');
                return;
            }

            SPOTIFY_CONFIG.clientId = clientId;
            SPOTIFY_CONFIG.redirectUri = redirectUri;

            // Save config
            storeConfig('clientId', clientId);
            storeConfig('redirectUri', redirectUri);

            // Generate state for security
            const state = generateRandomString(16);
            storeConfig('auth_state', state);

            // Build authorization URL
            const authUrl = buildAuthUrl(state);
            
            // Open authorization window
            window.open(authUrl, '_blank', 'width=400,height=600');
            
            // Listen for auth completion
            window.addEventListener('message', handleAuthMessage);
        }

        function buildAuthUrl(state) {
            const params = new URLSearchParams({
                response_type: 'code',
                client_id: SPOTIFY_CONFIG.clientId,
                scope: SPOTIFY_CONFIG.scopes.join(' '),
                redirect_uri: SPOTIFY_CONFIG.redirectUri,
                session_id:  SPOTIFY_CONFIG.sessionId,
                state: state
            });

            return `https://accounts.spotify.com/authorize?${params.toString()}`;
        }

        function handleAuthMessage(event) {
            if (event.data.type === 'SPOTIFY_AUTH_SUCCESS') {
                const { code, state } = event.data;
                
                // Verify state
                const storedState = getConfig('auth_state');
                if (state !== storedState) {
                    updateConnectionStatus('Authentifizierung fehlgeschlagen: Ung√ºltiger State', 'error');
                    return;
                }

                // Exchange code for tokens
                exchangeCodeForTokens(code, state);
            } else if (event.data.type === 'SPOTIFY_AUTH_ERROR') {
                updateConnectionStatus('Authentifizierung fehlgeschlagen', 'error');
            }
        }

        async function exchangeCodeForTokens(code,state) {
            try {
                const response = await fetch('http://192.168.56.1:8080/auth/spotify/callback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code, state })
                });


                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                accessToken = data.access_token;
                refreshToken = data.refresh_token;
                
                // Store tokens
                storeConfig('access_token', accessToken);
                storeConfig('refresh_token', refreshToken);
                
                updateConnectionStatus('Erfolgreich verbunden!', 'connected');
                startSpotifyUpdates();
                
            } catch (error) {
                console.error('Error exchanging code for tokens:', error);
                updateConnectionStatus('Token-Austausch fehlgeschlagen', 'error');
            }
        }

        function startSpotifyUpdates() {
            if (updateTimer) {
                clearInterval(updateTimer);
            }

            const interval = parseInt(document.getElementById('updateInterval').value) || 500;
            
            updateTimer = setInterval(async () => {
                await updateCurrentTrack();
            }, interval);

            // Initial update
            updateCurrentTrack();
        }

        async function updateCurrentTrack() {
            try {
                const currentlyPlaying = await spotifyApi.getCurrentlyPlaying();
                
                if (currentlyPlaying && currentlyPlaying.item) {
                    const track = currentlyPlaying.item;
                    isPlaying = currentlyPlaying.is_playing;
                    
                    updateTrackDisplay({
                        name: track.name,
                        artist: track.artists.map(a => a.name).join(', '),
                        album: track.album.name,
                        image: track.album.images[0]?.url || '',
                        duration: track.duration_ms,
                        progress: currentlyPlaying.progress_ms,
                        isPlaying: isPlaying
                    });
                } else {
                    // No track playing
                    if (document.getElementById('autoHide').checked) {
                        hideOverlay();
                    }
                }
            } catch (error) {
                console.error('Error updating current track:', error);
                // Try to refresh token
                await refreshAccessToken();
            }
        }

        function updateTrackDisplay(track) {
            const lyricsbox = document.getElementById('lyrics-box');
            const player = document.getElementById('spotify-player');
            const songTitle = document.getElementById('song-title');
            const songArtist = document.getElementById('song-artist');
            const albumImage = document.getElementById('album-image');
            const progressFill = document.getElementById('progress-fill');
            const currentTime = document.getElementById('current-time');
            const totalTime = document.getElementById('total-time');

            // Update track info
            songTitle.textContent = track.name;
            songArtist.textContent = track.artist;
            
            // Update album art
            if (track.image) {
                albumImage.src = track.image;
            }

            // Update progress
            const progressPercent = (track.progress / track.duration) * 100;
            progressFill.style.width = progressPercent + '%';

            // Update time display
            currentTime.textContent = formatTime(track.progress);
            totalTime.textContent = formatTime(track.duration);

            // Show/hide based on play state
            if (document.getElementById('autoHide').checked && !track.isPlaying) {
                hideOverlay();
            } else {
                showOverlay();
            }

            // Update animation
            if (track.isPlaying && document.getElementById('showAnimation').checked) {
                lyricsbox.classList.add('demo-song');
                player.classList.add('demo-song');
            } else {
                lyricsbox.classList.remove('demo-song');
                player.classList.remove('demo-song');
            }

            fetchLyrics(track);
        }

        function formatTime(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        let lrcLines = [];

        let lyricsBox = document.getElementById('lyrics-box');


        async function fetchLyrics(track) {
            try {
                const res = await fetch(`https://lrclib.net/api/get?artist_name=${encodeURIComponent(track.artist)}&track_name=${encodeURIComponent(track.name)}`);
                const data = await res.json();

                if (!data.syncedLyrics) {
                    lyricsBox.style.display = "none";
                    return;
                }

                lyricsBox.style.display = "block";

                lrcLines = parseLRC(data.syncedLyrics);

                startSync(track);
            } catch (e) {
                lyricsBox.style.display = "none";
                lyricsBox.textContent = "‚ùå Fehler beim Abrufen der Lyrics.";
                console.error(e);
            }
        }

        function parseLRC(lrcText) {
            const lines = lrcText
                .split('\n')
                .map(line => {
                const match = line.match(/\[(\d+):(\d+\.\d+)\](.*)/);
                if (!match) return null;
                const min = parseInt(match[1], 10);
                const sec = parseFloat(match[2]);
                const time = min * 60 + sec;
                
                return { time, text: match[3].trim() };
                })
                .filter(Boolean);

            // Zeile bei 0:00 hinzuf√ºgen
            lines.unshift({ time: 0, text: "" });

            return lines;
        }

        function msToSecondsObject(ms) {
            return ms / 1000;
        }

        function startSync(track) {
            function update() {
                const interval = parseInt(document.getElementById('updateInterval').value) || 500;
                const currentSec = msToSecondsObject(track.progress);

                // Index der aktuellen Zeile
                const currentIndex = lrcLines.findIndex((line, i) =>
                    currentSec >= line.time && (i === lrcLines.length - 1 || currentSec < lrcLines[i + 1].time)
                );

                if (currentIndex !== -1) {
                    const prev = lrcLines[currentIndex - 1]?.text?.replace("(", "\n(").trim();
                    const curr = lrcLines[currentIndex]?.text?.replace("(", "\n(").trim();
                    const next = lrcLines[currentIndex + 1]?.text?.replace("(", "\n(").trim();

                    if (currentIndex - 1 !== -1) {
                        document.getElementById('prev-line').innerHTML =
                            !prev ? '<img src="./musical-note.ico" height="18" alt="üéµ" />' : prev;
                    }else{
                        document.getElementById('prev-line').innerHTML = "";
                    }

                    document.getElementById('current-line').innerHTML =
                        !curr ? '<img src="./musical-note.ico" height="24" alt="üéµ" />' : curr;

                    if (currentIndex !== lrcLines.length - 1) {
                        document.getElementById('next-line').innerHTML =
                            !next ? '<img src="./musical-note.ico" height="18" alt="üéµ" />' : next;
                    }else{
                        document.getElementById('next-line').innerHTML = "";
                    }
                }

                requestAnimationFrame(update);
            }

            update();
        }


        function showOverlay() {
            const player = document.getElementById('spotify-player');
            player.style.display = 'flex';
        }

        function hideOverlay() {
            const player = document.getElementById('spotify-player');
            player.style.display = 'none';
        }

        async function refreshAccessToken() {
            if (!refreshToken) return;

            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': `Basic ${btoa(SPOTIFY_CONFIG.clientId + ':' + "3ef8eec436454258919e04ce16df0077")}`
                    },
                    body: new URLSearchParams({
                        grant_type: 'refresh_token',
                        refresh_token: refreshToken
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                accessToken = data.access_token;
                storeConfig('access_token', accessToken);
                
                if (data.refresh_token) {
                    refreshToken = data.refresh_token;
                    storeConfig('refresh_token', refreshToken);
                }
            } catch (error) {
                console.error('Error refreshing access token:', error);
                updateConnectionStatus('Token-Erneuerung fehlgeschlagen', 'error');
            }
        }

        function updateConnectionStatus(message, type = '') {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = statusElement.querySelector('.status-text');
            
            statusText.textContent = message;
            statusText.className = `status-text ${type}`;
        }

        function generateRandomString(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        // Storage helpers (using in-memory storage for demo)
        const storage = {};

        function storeConfig(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }

        function getConfig(key) {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : null;
        }


        function loadStoredConfig() {
            const clientId = getConfig('clientId');
            const redirectUri = getConfig('redirectUri');
            const storedAccessToken = getConfig('access_token');
            const storedRefreshToken = getConfig('refresh_token');

            if (clientId) {
                document.getElementById('clientId').value = clientId;
                SPOTIFY_CONFIG.clientId = clientId;
            }
            
            if (redirectUri) {
                document.getElementById('redirectUri').value = redirectUri;
                SPOTIFY_CONFIG.redirectUri = redirectUri;
            }

            if (storedAccessToken) {
                accessToken = storedAccessToken;
                refreshToken = storedRefreshToken;
                updateConnectionStatus('Verbunden (gespeicherte Session)', 'connected');
                startSpotifyUpdates();
            }
        }

        // View Toggle
        function toggleView() {
            const settingsPage = document.getElementById('settings-page');
            const overlayPage = document.getElementById('overlay-page');
            const toggleText = document.getElementById('toggle-text');
            
            if (currentView === 'settings') {
                settingsPage.classList.remove('active');
                overlayPage.classList.add('active');
                toggleText.textContent = 'Zu Einstellungen wechseln';
                currentView = 'overlay';
                //startDemoAnimation();
            } else {
                overlayPage.classList.remove('active');
                settingsPage.classList.add('active');
                toggleText.textContent = 'Zu Overlay wechseln';
                currentView = 'settings';
                stopDemoAnimation();
            }
        }

        // Demo Animation
        function startDemoAnimation() {
            const progressFill = document.getElementById('progress-fill');
            const currentTime = document.getElementById('current-time');
            const totalSeconds = 355; // 5:55
            
            demoInterval = setInterval(() => {
                demoProgress += 1;
                if (demoProgress > totalSeconds) {
                    demoProgress = 0;
                }
                
                const percentage = (demoProgress / totalSeconds) * 100;
                progressFill.style.width = percentage + '%';
                
                const minutes = Math.floor(demoProgress / 60);
                const seconds = demoProgress % 60;
                currentTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopDemoAnimation() {
            if (demoInterval) {
                clearInterval(demoInterval);
            }
        }

        // Settings Application
        function applySettings() {
            const player = document.getElementById('spotify-player');
            const lyricsbox = document.getElementById('lyrics-box')
            const songTitle = document.getElementById('song-title');
            const songArtist = document.getElementById('song-artist');
            const progressContainer = document.getElementById('progress-container');
            const albumArt = document.getElementById('album-art');
            
            // Position & Size
            const posX = document.getElementById('posX').value;
            const posY = parseInt(document.getElementById('posY').value, 10);
            const width = document.getElementById('width').value;
            const height = document.getElementById('height').value;
            
            player.style.width = width + 'px';
            player.style.height = height + 'px';
            player.style.position = 'fixed';
            player.style.left = posX + 'px';
            player.style.top = posY + 'px';

            lyricsbox.style.width = width + 'px';
            lyricsbox.style.position = 'fixed';
            lyricsbox.style.left = posX + 'px';
            lyricsbox.style.top = (posY + 170) + 'px';
            
            // Visibility
            const showSongName = document.getElementById('showSongName').checked;
            const showArtist = document.getElementById('showArtist').checked;
            const showTimeline = document.getElementById('showTimeline').checked;
            const showAlbumArt = document.getElementById('showAlbumArt').checked;
            
            songTitle.style.display = showSongName ? 'block' : 'none';
            songArtist.style.display = showArtist ? 'block' : 'none';
            progressContainer.style.display = showTimeline ? 'block' : 'none';
            albumArt.style.display = showAlbumArt ? 'flex' : 'none';
            
            // Design
            const bgOpacity = document.getElementById('bgOpacity').value;
            const borderRadius = document.getElementById('borderRadius').value;
            const titleSize = document.getElementById('titleSize').value;
            
            player.style.backgroundColor = `rgba(45, 45, 45, ${bgOpacity / 100})`;
            //player.style.borderRadius = borderRadius + 'px';
            songTitle.style.fontSize = titleSize;
            
            // Animation
            const showAnimation = document.getElementById('showAnimation').checked;
            if (showAnimation) {
                lyricsbox.classList.add('demo-song');
                player.classList.add('demo-song');
            } else {
                lyricsbox.classList.remove('demo-song');
                player.classList.remove('demo-song');
            }
            
            // Update opacity display
            document.getElementById('opacityValue').textContent = bgOpacity + '%';
            
            // Restart Spotify updates with new interval
            if (accessToken) {
                startSpotifyUpdates();
            }
        }

        // Opacity slider update
        document.getElementById('bgOpacity').addEventListener('input', function() {
            document.getElementById('opacityValue').textContent = this.value + '%';
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load stored configuration
            loadStoredConfig();
            
            // Set initial demo state
            demoProgress = 154; // Start at 2:34
            
            // Handle OAuth callback if present
            handleOAuthCallback();
        });

        function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'SPOTIFY_AUTH_ERROR',
                        error: error
                    }, '*');
                    window.close();
                }
                return;
            }

            if (code && state) {
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'SPOTIFY_AUTH_SUCCESS',
                        code: code,
                        state: state
                    }, '*');
                    window.close();
                }
            }
        }

        document.addEventListener('mousemove', function (e) {
            const button = document.querySelector('.toggle-view');
            const screenWidth = window.innerWidth;
            
            if (e.clientX >= screenWidth - 300) {
                button.style.opacity = '1';
                button.style.pointerEvents = 'auto';
            } else {
                button.style.opacity = '0';
                button.style.pointerEvents = 'none';
            }
        });

        //applySettings();
    </script>
</body>
</html>